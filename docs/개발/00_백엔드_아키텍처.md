# Feel&Note 백엔드 아키텍처

## 기술 스택

| 영역 | 기술 | 선택 이유 |
|------|------|-----------|
| 프레임워크 | Next.js 16 (App Router) | 프론트엔드와 통합, Server Actions |
| 데이터베이스 | Supabase (PostgreSQL) | 실시간 구독, Row Level Security |
| 인증 | Supabase Auth | OAuth 지원, 세션 관리 내장 |
| 스토리지 | Supabase Storage | 이미지 업로드, CDN 제공 |

---

## 아키텍처 개요

```
┌─────────────────────────────────────────────────────────────┐
│                        Client (Browser)                      │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     Next.js App Router                       │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │  Server Actions │  │  API Routes     │  │ Middleware   │ │
│  │  (mutations)    │  │  (webhooks)     │  │ (auth check) │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                        Supabase                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ PostgreSQL  │  │   Auth      │  │     Storage         │  │
│  │ + RLS       │  │             │  │   (thumbnails)      │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     External APIs                            │
│  ┌─────────────┐  ┌─────────────┐                           │
│  │ 알라딘 API  │  │   TMDB      │                           │
│  │ (도서)      │  │ (영화)      │                           │
│  └─────────────┘  └─────────────┘                           │
└─────────────────────────────────────────────────────────────┘
```

---

## 디렉토리 구조

```
sw/web/
├── src/
│   ├── app/
│   │   ├── api/                    # API Routes (webhooks)
│   │   ├── auth/                   # 인증 콜백
│   │   │   └── callback/
│   │   └── (main)/                 # 메인 레이아웃
│   │       ├── archive/            # 기록관
│   │       ├── dashboard/          # 대시보드
│   │       └── ...
│   │
│   ├── actions/                    # Server Actions
│   │   ├── auth/                   # 인증 관련
│   │   │   ├── login.ts
│   │   │   ├── logout.ts
│   │   │   └── index.ts
│   │   ├── contents/               # 콘텐츠 CRUD
│   │   │   ├── addContent.ts
│   │   │   ├── getContent.ts
│   │   │   ├── getMyContents.ts
│   │   │   ├── updateStatus.ts
│   │   │   ├── removeContent.ts
│   │   │   ├── searchBooks.ts
│   │   │   └── index.ts
│   │   └── records/                # 기록 CRUD
│   │       ├── createRecord.ts
│   │       ├── getRecord.ts
│   │       ├── updateRecord.ts
│   │       ├── deleteRecord.ts
│   │       └── index.ts
│   │
│   ├── lib/
│   │   ├── supabase/
│   │   │   ├── client.ts           # 브라우저 클라이언트
│   │   │   ├── server.ts           # 서버 클라이언트
│   │   │   └── middleware.ts       # 미들웨어 헬퍼
│   │   └── api/                    # 외부 API 래퍼
│   │       ├── aladin.ts
│   │       └── tmdb.ts
│   │
│   ├── types/
│   │   └── database.ts             # DB 타입 정의
│   │
│   └── middleware.ts               # Next.js 미들웨어
│
└── supabase/
    └── migrations/                 # 마이그레이션 SQL
```

---

## 데이터베이스 구조

### 테이블

| 테이블 | 설명 |
|--------|------|
| `profiles` | 사용자 프로필 (auth.users 확장) |
| `contents` | 콘텐츠 마스터 (도서, 영화) |
| `user_contents` | 사용자-콘텐츠 관계 |
| `records` | 기록 (리뷰, 노트, 인용구) |

### 관계

```
profiles ─────< user_contents >───── contents
    │                │
    │                │
    └────────< records >──────────────┘
```

---

## 데이터 흐름

### 1. 콘텐츠 추가 흐름

```
사용자 → 콘텐츠 검색 (외부 API)
       → 콘텐츠 선택
       → addContent Server Action
       → contents 테이블 upsert (없으면 생성)
       → user_contents 테이블 insert
```

### 2. 기록 작성 흐름

```
사용자 → 기록 작성
       → createRecord Server Action
       → user_contents 존재 확인
       → records 테이블 insert
```

### 3. 기록관 조회 흐름

```
사용자 → 기록관 페이지 진입
       → getMyContents Server Action
       → user_contents + contents 조인 조회
       → RLS 자동 적용 (본인 데이터만)
       → 클라이언트 렌더링
```

---

## 보안 설계

### Row Level Security (RLS) 정책

| 테이블 | SELECT | INSERT | UPDATE | DELETE |
|--------|--------|--------|--------|--------|
| profiles | 모두 | 본인 | 본인 | - |
| contents | 모두 | 인증된 사용자 | - | - |
| user_contents | 본인 | 본인 | 본인 | 본인 |
| records | 본인 | 본인 | 본인 | 본인 |

### 인증 흐름

```
1. 소셜 로그인 (Google, Kakao)
2. Supabase Auth 세션 생성
3. Next.js Middleware에서 세션 검증
4. Server Actions에서 getUser() 호출
5. RLS 자동 적용
```

---

## 외부 API 연동

### 알라딘 API (도서)

- 검색: `ItemSearch.aspx`
- 상세: `ItemLookUp.aspx`
- 인증: API Key (Query Parameter)

### TMDB (영화) - 향후 확장

- 검색: `/search/movie`
- 상세: `/movie/{id}`
- 인증: Bearer Token

---

## 성능 최적화

### 인덱스

- `user_contents(user_id, content_id)` - 중복 방지, 조회 최적화

### 캐싱

- Next.js `revalidatePath`로 페이지 캐시 무효화

### 페이지네이션

- 커서 기반 페이지네이션 예정

---

## 하위 문서

- [01_데이터베이스_스키마.md](./01_데이터베이스_스키마.md)
- [02_API_설계.md](./02_API_설계.md)
- [03_인증_인가.md](./03_인증_인가.md)

---

*00_백엔드_아키텍처.md*
